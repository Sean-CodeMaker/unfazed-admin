{"version":3,"sources":["src/pages/oauth/login/index.tsx"],"sourcesContent":["import { useModel } from '@umijs/max';\nimport { App, Spin } from 'antd';\nimport React, { useEffect } from 'react';\nimport { flushSync } from 'react-dom';\nimport { getAdminSettings, login } from '@/services/api';\nimport { getRouteAndMenuData } from '@/utils/routeManager';\nimport Settings from '../../../../config/defaultSettings';\n\nconst OAuthLogin: React.FC = () => {\n  const { message } = App.useApp();\n  const { setInitialState } = useModel('@@initialState');\n\n  const updateUserInfoAndSettings = async (\n    loginData: API.LoginResult['data'],\n    platform?: string,\n  ) => {\n    if (loginData) {\n      // 转换登录返回的数据为 CurrentUser 格式\n      const userInfo: API.CurrentUser = {\n        name:\n          loginData.extra?.nickname ||\n          loginData.extra?.username ||\n          loginData.account,\n        avatar: loginData.extra?.avatar,\n        userid: loginData.account,\n        email: loginData.email,\n        account: loginData.account,\n        roles: loginData.roles,\n        groups: loginData.groups,\n        extra: { ...loginData.extra, platform: platform || 'default' },\n        // 设置访问权限\n        access: loginData.roles?.[0]?.name || 'user',\n      };\n\n      // 获取用户设置\n      let settings = Settings;\n      try {\n        const response = await getAdminSettings({\n          skipErrorHandler: true,\n        });\n        if (response.code === 0) {\n          // 合并API设置和默认设置，保留前端特有字段\n          settings = {\n            ...response.data,\n            fixSiderbar: response.data.fixSiderbar ?? Settings.fixSiderbar,\n            pwa: response.data.pwa ?? Settings.pwa,\n            iconfontUrl: response.data.iconfontUrl ?? Settings.iconfontUrl,\n          } as any;\n\n          // 保存OAuth认证插件信息到本地存储\n          if (response.data?.authPlugins) {\n            localStorage.setItem(\n              'authPlugins',\n              JSON.stringify(response.data.authPlugins),\n            );\n          }\n        }\n      } catch (_error) {\n        console.warn(\n          'Failed to fetch settings after login, using default settings',\n        );\n      }\n\n      // 获取动态路由和菜单数据（只有登录用户才能获取）\n      let routeList: API.AdminRoute[] = [];\n      let menuData: any[] = [];\n      try {\n        const routeAndMenuData = await getRouteAndMenuData();\n        routeList = routeAndMenuData.routeList;\n        menuData = routeAndMenuData.menuData;\n        console.log('OAuth登录成功，已获取动态路由:', routeList);\n      } catch (error) {\n        console.warn('获取动态路由失败，使用空路由:', error);\n      }\n\n      // 保存用户信息到本地存储\n      localStorage.setItem('userInfo', JSON.stringify(userInfo));\n      localStorage.setItem('userSettings', JSON.stringify(settings));\n\n      flushSync(() => {\n        setInitialState((s) => ({\n          ...s,\n          currentUser: userInfo,\n          settings: settings as any,\n          menuData,\n          routeList,\n        }));\n      });\n    }\n  };\n\n  useEffect(() => {\n    const handleOAuthCallback = async () => {\n      console.log('开始处理OAuth回调...');\n\n      // 获取URL参数\n      const urlParams = new URLSearchParams(window.location.search);\n      const error = urlParams.get('error');\n\n      // 从localStorage获取platform（在点击OAuth图标时已存储）\n      let platform = localStorage.getItem('oauth_platform');\n      console.log('platform from localStorage:', platform);\n      console.log('URL search params:', window.location.search);\n\n      // 处理OAuth错误\n      if (error) {\n        message.error(`OAuth登录失败: ${error}`);\n        // 清理localStorage并跳转回登录页面\n        localStorage.removeItem('oauth_platform');\n        window.location.href = '/admin/user/login';\n        return;\n      }\n\n      // 如果localStorage中没有platform，设置默认值（用于手动测试）\n      if (!platform) {\n        platform = 'oauth';\n        console.log(\n          'No platform found in localStorage, using default \"oauth\" for OAuth callback testing',\n        );\n      }\n\n      try {\n        message.loading('正在处理OAuth登录...', 0);\n\n        // 收集所有querystring参数作为extra数据\n        const extraData: Record<string, any> = {};\n\n        // 遍历所有URL参数，收集到extra中\n        urlParams.forEach((value, key) => {\n          extraData[key] = value;\n        });\n\n        // 如果有state，尝试解析其中的额外信息\n        const state = urlParams.get('state');\n        if (state) {\n          try {\n            const stateData = JSON.parse(decodeURIComponent(state));\n            extraData.state_data = stateData;\n          } catch (_e) {\n            // 解析失败时保持原始state值\n            extraData.state = state;\n          }\n        }\n\n        console.log('OAuth callback params:', { platform, extraData });\n\n        // 调用登录API\n        const loginResult = await login({\n          account: '', // OAuth登录不需要account\n          password: '', // OAuth登录不需要password\n          platform: platform,\n          extra: extraData,\n        });\n\n        message.destroy(); // 清除loading消息\n\n        if (loginResult.code === 0) {\n          message.success('OAuth登录成功！');\n          // 处理登录成功逻辑\n          await updateUserInfoAndSettings(loginResult.data, platform);\n\n          // 清理localStorage中的platform信息\n          localStorage.removeItem('oauth_platform');\n\n          // 成功后跳转到首页\n          window.location.href = '/admin/';\n        } else {\n          message.error(loginResult.message || 'OAuth登录失败');\n          // 清理localStorage\n          localStorage.removeItem('oauth_platform');\n          // 失败后跳转回登录页面\n          setTimeout(() => {\n            window.location.href = '/admin/user/login';\n          }, 2000);\n        }\n      } catch (error) {\n        message.destroy();\n        message.error('OAuth登录处理失败，请重试');\n        console.error('OAuth login error:', error);\n        // 清理localStorage\n        localStorage.removeItem('oauth_platform');\n        // 错误后跳转回登录页面\n        setTimeout(() => {\n          window.location.href = '/admin/user/login';\n        }, 2000);\n      }\n    };\n\n    handleOAuthCallback();\n  }, [message, setInitialState]);\n\n  return (\n    <div\n      style={{\n        display: 'flex',\n        flexDirection: 'column',\n        alignItems: 'center',\n        justifyContent: 'center',\n        height: '100vh',\n        background: 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',\n      }}\n    >\n      <div\n        style={{\n          background: 'white',\n          padding: '40px',\n          borderRadius: '10px',\n          boxShadow: '0 10px 25px rgba(0,0,0,0.1)',\n          textAlign: 'center',\n          minWidth: '300px',\n        }}\n      >\n        <Spin size=\"large\" />\n        <div\n          style={{\n            marginTop: '20px',\n            fontSize: '16px',\n            color: '#666',\n            fontWeight: 500,\n          }}\n        >\n          正在处理OAuth登录...\n        </div>\n        <div\n          style={{\n            marginTop: '10px',\n            fontSize: '14px',\n            color: '#999',\n          }}\n        >\n          请稍候，即将跳转到主页\n        </div>\n      </div>\n    </div>\n  );\n};\n\nexport default OAuthLogin;\n"],"names":[],"mappings":"+PA6OA,+CAAA,8CA7OyB,0DAEQ,gBACP,gBACc,gBACJ,oBACf,aAuOrB,EArO6B,KAC3B,GAAM,CAAE,QAAA,CAAO,CAAE,CAAG,SAAG,CAAC,MAAM,GACxB,CAAE,gBAAA,CAAe,CAAE,CAAG,GAAA,UAAQ,EAAC,kBAE/B,EAA4B,MAChC,EACA,KAEA,GAAI,EAAW,KAIT,EACA,EAEM,EAQA,EAAA,EAmBF,EAhCR,IAAM,EAA4B,CAChC,KACE,SAAA,EAAA,EAAU,KAAK,YAAf,SAAA,EAAiB,QAAQ,YACzB,EAAA,EAAU,KAAK,YAAf,SAAA,EAAiB,QAAQ,GACzB,EAAU,OAAO,CACnB,MAAM,SAAE,EAAA,EAAU,KAAK,YAAf,SAAA,EAAiB,MAAM,CAC/B,OAAQ,EAAU,OAAO,CACzB,MAAO,EAAU,KAAK,CACtB,QAAS,EAAU,OAAO,CAC1B,MAAO,EAAU,KAAK,CACtB,OAAQ,EAAU,MAAM,CACxB,MAAO,CAAE,GAAG,EAAU,KAAK,CAAE,SAAU,GAAY,SAAU,EAE7D,OAAQ,SAAA,EAAA,EAAU,KAAK,YAAf,iBAAA,EAAA,CAAiB,CAAC,EAAE,YAApB,SAAA,EAAsB,IAAI,GAAI,MACxC,EAGI,EAAW,SAAQ,CACvB,GAAI,CACF,IAAM,EAAW,MAAM,GAAA,kBAAgB,EAAC,CACtC,iBAAkB,CAAA,CACpB,GACsB,IAAlB,EAAS,IAAI,GAEf,EAAW,CACT,GAAG,EAAS,IAAI,CAChB,YAAa,EAAS,IAAI,CAAC,WAAW,EAAI,SAAQ,CAAC,WAAW,CAC9D,IAAK,EAAS,IAAI,CAAC,GAAG,EAAI,SAAQ,CAAC,GAAG,CACtC,YAAa,EAAS,IAAI,CAAC,WAAW,EAAI,SAAQ,CAAC,WAAW,AAChE,WAGI,EAAA,EAAS,IAAI,YAAb,SAAA,EAAe,WAAW,GAC5B,aAAa,OAAO,CAClB,cACA,KAAK,SAAS,CAAC,EAAS,IAAI,CAAC,WAAW,IAIhD,CAAE,MAAO,EAAQ,CACf,QAAQ,IAAI,CACV,gEAEJ,CAGA,IAAI,EAA8B,EAAE,CAChC,EAAkB,EAAE,CACxB,GAAI,CACF,IAAM,EAAmB,MAAM,GAAA,qBAAmB,IAClD,EAAY,EAAiB,SAAS,CACtC,EAAW,EAAiB,QAAQ,CACpC,QAAQ,GAAG,CAAC,iFAAsB,GACpC,CAAE,MAAO,EAAO,CACd,QAAQ,IAAI,CAAC,wFAAmB,GAClC,CAGA,aAAa,OAAO,CAAC,WAAY,KAAK,SAAS,CAAC,IAChD,aAAa,OAAO,CAAC,eAAgB,KAAK,SAAS,CAAC,IAEpD,GAAA,WAAS,EAAC,KACR,EAAgB,AAAC,GAAO,CAAA,CACtB,GAAG,CAAC,CACJ,YAAa,EACb,SAAU,EACV,SAAA,EACA,UAAA,CACF,CAAA,GACF,GACF,CACF,EAsGA,MApGA,GAAA,WAAS,EAAC,KAiGR,AAhG4B,CAAA,UAC1B,QAAQ,GAAG,CAAC,gDAGZ,IAAM,EAAY,IAAI,gBAAgB,OAAO,QAAQ,CAAC,MAAM,EACtD,EAAQ,EAAU,GAAG,CAAC,SAGxB,EAAW,aAAa,OAAO,CAAC,kBAKpC,GAJA,QAAQ,GAAG,CAAC,8BAA+B,GAC3C,QAAQ,GAAG,CAAC,qBAAsB,OAAO,QAAQ,CAAC,MAAM,EAGpD,EAAO,CACT,EAAQ,KAAK,CAAC,CAAC,uCAAW,EAAE,EAAM,CAAC,EAEnC,aAAa,UAAU,CAAC,kBACxB,OAAO,QAAQ,CAAC,IAAI,CAAG,oBACvB,OACF,CAGK,IACH,EAAW,QACX,QAAQ,GAAG,CACT,wFAIJ,GAAI,CACF,EAAQ,OAAO,CAAC,+CAAkB,GAGlC,IAAM,EAAiC,CAAC,EAGxC,EAAU,OAAO,CAAC,CAAC,EAAO,KACxB,CAAS,CAAC,EAAI,CAAG,EACnB,GAGA,IAAM,EAAQ,EAAU,GAAG,CAAC,SAC5B,GAAI,EACF,GAAI,CACF,IAAM,EAAY,KAAK,KAAK,CAAC,mBAAmB,IAChD,EAAU,UAAU,CAAG,EACzB,CAAE,MAAO,EAAI,CAEX,EAAU,KAAK,CAAG,EACpB,CAGF,QAAQ,GAAG,CAAC,yBAA0B,CAAE,SAAA,EAAU,UAAA,CAAU,GAG5D,IAAM,EAAc,MAAM,GAAA,OAAK,EAAC,CAC9B,QAAS,GACT,SAAU,GACV,SAAU,EACV,MAAO,CACT,GAEA,EAAQ,OAAO,GAEX,AAAqB,IAArB,EAAY,IAAI,EAClB,EAAQ,OAAO,CAAC,uCAEhB,MAAM,EAA0B,EAAY,IAAI,CAAE,GAGlD,aAAa,UAAU,CAAC,kBAGxB,OAAO,QAAQ,CAAC,IAAI,CAAG,YAEvB,EAAQ,KAAK,CAAC,EAAY,OAAO,EAAI,iCAErC,aAAa,UAAU,CAAC,kBAExB,WAAW,KACT,OAAO,QAAQ,CAAC,IAAI,CAAG,oBACzB,EAAG,MAEP,CAAE,MAAO,EAAO,CACd,EAAQ,OAAO,GACf,EAAQ,KAAK,CAAC,qEACd,QAAQ,KAAK,CAAC,qBAAsB,GAEpC,aAAa,UAAU,CAAC,kBAExB,WAAW,KACT,OAAO,QAAQ,CAAC,IAAI,CAAG,oBACzB,EAAG,KACL,CACF,CAAA,IAGF,EAAG,CAAC,EAAS,EAAgB,EAG3B,UAAC,OACC,MAAO,CACL,QAAS,OACT,cAAe,SACf,WAAY,SACZ,eAAgB,SAChB,OAAQ,QACR,WAAY,mDACd,WAEA,WAAC,OACC,MAAO,CACL,WAAY,QACZ,QAAS,OACT,aAAc,OACd,UAAW,8BACX,UAAW,SACX,SAAU,OACZ,YAEA,UAAC,SAAI,EAAC,KAAK,UACX,UAAC,OACC,MAAO,CACL,UAAW,OACX,SAAU,OACV,MAAO,OACP,WAAY,GACd,WACD,iDAGD,UAAC,OACC,MAAO,CACL,UAAW,OACX,SAAU,OACV,MAAO,MACT,WACD,4EAMT"}