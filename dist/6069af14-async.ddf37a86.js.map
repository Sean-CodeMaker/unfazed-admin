{"version":3,"sources":["src/pages/DynamicRoute.tsx"],"sourcesContent":["import { history, useLocation, useModel } from '@umijs/max';\nimport { Spin } from 'antd';\nimport React, { useEffect, useState } from 'react';\nimport { ModelAdmin, ModelCustom } from '@/components';\n\n/**\n * 动态路由组件\n * 根据当前路径和 route-list 接口返回的配置，动态渲染相应的组件\n */\nconst DynamicRoute: React.FC = () => {\n  const location = useLocation();\n  const { initialState } = useModel('@@initialState');\n  const [loading, setLoading] = useState(true);\n  const [routeConfig, setRouteConfig] = useState<API.AdminRoute | null>(null);\n  const [error, setError] = useState<string | null>(null);\n\n  useEffect(() => {\n    const loadRoute = () => {\n      try {\n        setLoading(true);\n        setError(null);\n        // 不要立即重置 routeConfig，避免中间状态的渲染\n\n        console.log('Loading route for path:', location.pathname);\n\n        // 检查全局状态中是否有路由数据\n        const routeList = initialState?.routeList;\n\n        if (!routeList || routeList.length === 0) {\n          // 如果没有路由数据，可能是用户未登录或路由加载失败\n          console.warn('Route list not available in global state');\n\n          // 检查是否是需要登录的页面\n          const publicPaths = [\n            '/user/login',\n            '/oauth/login',\n            '/exception',\n            '/result',\n          ];\n          const isPublicPath = publicPaths.some((path) =>\n            location.pathname.startsWith(path),\n          );\n\n          if (!isPublicPath) {\n            // 对于需要登录的页面，重定向到登录页面\n            history.replace('/user/login');\n            return;\n          } else {\n            // 对于公共页面，抛出错误让静态路由处理\n            throw new Error(\n              'Route list not available, but this should be handled by static routes',\n            );\n          }\n        }\n\n        // 处理根路径重定向\n        if (location.pathname === '/') {\n          // 获取第一个可用的动态路由进行重定向\n          const getFirstAvailableRoute = (\n            routes: API.AdminRoute[],\n          ): string | null => {\n            for (const route of routes) {\n              if (route.routes && route.routes.length > 0) {\n                const firstChild = getFirstAvailableRoute(route.routes);\n                if (firstChild) return firstChild;\n              } else if (route.path && route.component) {\n                return route.path;\n              }\n            }\n            return null;\n          };\n\n          const redirectPath = getFirstAvailableRoute(routeList);\n          if (redirectPath) {\n            console.log('Redirecting from root to:', redirectPath);\n            history.replace(redirectPath);\n            return;\n          } else {\n            throw new Error('No available routes for redirection');\n          }\n        }\n\n        // 查找当前路径对应的路由配置\n        const findRouteByPath = (\n          routes: API.AdminRoute[],\n          targetPath: string,\n        ): API.AdminRoute | null => {\n          for (const route of routes) {\n            if (route.path === targetPath) {\n              return route;\n            }\n            if (route.routes && route.routes.length > 0) {\n              const found = findRouteByPath(route.routes, targetPath);\n              if (found) return found;\n            }\n          }\n          return null;\n        };\n\n        const foundRoute = findRouteByPath(routeList, location.pathname);\n\n        if (!foundRoute) {\n          // 对于找不到的路由，重定向到 404 页面\n          history.replace('/exception/404');\n          return;\n        }\n\n        console.log('Found route config:', foundRoute);\n        setRouteConfig(foundRoute);\n      } catch (err) {\n        console.error('Dynamic route loading error:', err);\n        setError(err instanceof Error ? err.message : 'Unknown error occurred');\n      } finally {\n        setLoading(false);\n      }\n    };\n\n    // 每次路径变化时都重新加载路由\n    if (initialState?.routeList) {\n      loadRoute();\n      return; // 添加 return 语句\n    } else {\n      // 等待全局状态加载完成\n      setLoading(true);\n      const timer = setTimeout(() => {\n        if (initialState?.routeList) {\n          loadRoute();\n        } else {\n          setError('Failed to load route configuration from global state');\n          setLoading(false);\n        }\n      }, 100);\n\n      return () => clearTimeout(timer);\n    }\n  }, [location.pathname, initialState?.routeList]);\n\n  // 渲染对应的组件\n  const renderComponent = () => {\n    // Avoid rendering with stale routeConfig when path just changed\n    if (!routeConfig || routeConfig.path !== location.pathname) {\n      return (\n        <div\n          style={{\n            display: 'flex',\n            justifyContent: 'center',\n            alignItems: 'center',\n            height: '50vh',\n          }}\n        >\n          <Spin size=\"large\" tip=\"Loading...\" />\n        </div>\n      );\n    }\n\n    const modelName = routeConfig.name;\n    // Use routeConfig.path to stabilize key with the actual config we will render\n    const componentKey = `${routeConfig.component}-${routeConfig.path}`;\n\n    switch (routeConfig.component) {\n      case 'ModelAdmin':\n        return <ModelAdmin key={componentKey} modelName={modelName} />;\n      case 'ModelCustom':\n        return (\n          <ModelCustom\n            key={componentKey}\n            toolName={modelName}\n            onBack={() => window.history.back()}\n          />\n        );\n      default:\n        return (\n          <div key={componentKey}>\n            Unsupported dynamic component: {routeConfig.component}\n          </div>\n        );\n    }\n  };\n\n  if (loading) {\n    return (\n      <div\n        style={{\n          display: 'flex',\n          justifyContent: 'center',\n          alignItems: 'center',\n          height: '50vh',\n        }}\n      >\n        <Spin size=\"large\" tip=\"Loading...\" />\n      </div>\n    );\n  }\n\n  if (error) {\n    return (\n      <div\n        style={{\n          display: 'flex',\n          justifyContent: 'center',\n          alignItems: 'center',\n          height: '50vh',\n          flexDirection: 'column',\n        }}\n      >\n        <h3>Error Loading Route</h3>\n        <p>{error}</p>\n      </div>\n    );\n  }\n\n  return renderComponent();\n};\n\nexport default DynamicRoute;\n"],"names":[],"mappings":"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"}