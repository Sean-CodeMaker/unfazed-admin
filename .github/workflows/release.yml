name: Build and Release

on:
  push:
    tags:
      - 'v*' # 只在推送版本标签时触发

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    
    steps:
      # 1️⃣ 拉取代码，包含 tag
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0   # 获取完整历史，保证 tag 可用

      # 2️⃣ Setup Node.js
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'

      # 3️⃣ Install dependencies
      - name: Install dependencies
        run: npm install

      # 4️⃣ Lint
      - name: Run linting
        run: npm run lint

      # 5️⃣ Build
      - name: Build project
        run: npm run build

      # 6️⃣ 确认 build 输出目录存在
      - name: Verify build output
        run: |
          if [ ! -d dist ]; then
            echo "Build failed: dist folder not found!"
            exit 1
          fi

      # 7️⃣ 打包 build 产物
      - name: Create release archive
        run: |
          tar -czf unfazed-admin-${{ github.ref_name }}.tar.gz -C dist .

      # 8️⃣ 创建 GitHub Release 并上传
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: unfazed-admin-${{ github.ref_name }}.tar.gz
          name: Release ${{ github.ref_name }}
          body: |
            ## Changes in ${{ github.ref_name }}
            
            Built from commit: ${{ github.sha }}
            
            ### Installation
            1. Download `unfazed-admin-${{ github.ref_name }}.tar.gz`
            2. Extract to your web server directory
            3. Configure your server to serve `/admin/` path with SPA fallback
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
